name: iOS Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0

      - name: Install fastlane
        run: |
          gem install fastlane

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Delete corrupted Package.resolved
        run: |
          if [ -f StepRunningCoach.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved ]; then
            rm StepRunningCoach.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved
          fi

      - name: Update OpenSSL
        run: |
          brew update && brew upgrade openssl

      - name: Create AuthKey.json
        run: |
          echo '{
            "key_id": "${{ secrets.APPSTORE_API_KEY_ID }}",
            "issuer_id": "${{ secrets.APPSTORE_ISSUER_ID }}",
            "key": "${{ secrets.APPSTORE_API_PRIVATE_KEY }}",
            "is_key_content_base64": true,
            "in_house": false
          }' > AuthKey.json

      - name: Setup Fastlane and Authenticate with Apple
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        run: |
          bundle exec fastlane match appstore --api_key_path AuthKey.json --readonly

      - name: Build and Archive
        run: |
          bundle exec fastlane gym --scheme "StepRunningCoach" \
            --archive_path "$PWD/build/StepRunningCoach.xcarchive" \
            --export_method "app-store" \
            --output_directory "$PWD/build" \
            --output_name "StepRunningCoach.ipa" \
            --clean \
            --codesigning_identity "iPhone Distribution" \
            --allowProvisioningUpdates \
            --export_method "app-store"

      - name: Upload IPA to TestFlight using Fastlane
        run: |
          bundle exec fastlane pilot upload \
            --ipa "$PWD/build/StepRunningCoach.ipa" \
            --api_key_path "AuthKey.json"
